# Kali Linux Rolling - Metasploit Edition
# https://www.kali.org/docs/containers/official-kalilinux-docker-images/
FROM kalilinux/kali-rolling:latest

LABEL maintainer="sealmindset" \
    description="Kali Linux with Metasploit Framework" \
    version="2.0"

# Set environment
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=en_US.UTF-8 \
    GOROOT=/usr/lib/go \
    GOPATH=/root/go \
    PATH=/root/go/bin:/usr/lib/go/bin:$PATH

WORKDIR /root

# Update and upgrade to latest
RUN apt-get update && \
    apt-get -y full-upgrade && \
    apt-get -y autoremove && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Metasploit Framework (large package, separate layer)
RUN apt-get update && apt-get install -y --no-install-recommends \
    metasploit-framework \
    postgresql-client \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install core tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build tools
    build-essential \
    # Programming languages
    golang \
    nodejs \
    npm \
    python3-pip \
    python3-venv \
    python3-dev \
    # Core security tools
    nmap \
    nikto \
    dirb \
    sqlmap \
    # Network tools
    curl \
    wget \
    whois \
    netcat-traditional \
    net-tools \
    iputils-ping \
    dnsutils \
    proxychains4 \
    tor \
    # Reversing
    apktool \
    dex2jar \
    # Exploitation
    exploitdb \
    # Sniffing/MITM
    responder \
    # Misc utilities
    git \
    vim \
    zsh \
    jq \
    lsof \
    strace \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Go-based tools (security + API scanning)
RUN go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest && \
    go install github.com/projectdiscovery/httpx/cmd/httpx@latest && \
    go install github.com/ffuf/ffuf/v2@latest && \
    nuclei -update-templates && \
    cp /root/go/bin/* /usr/local/bin/

# Install kiterunner from release binary
RUN curl -sL https://github.com/assetnote/kiterunner/releases/download/v1.0.2/kiterunner_1.0.2_linux_arm64.tar.gz | \
    tar xzf - -C /usr/local/bin kr || true

# Install Python tools (API scanning)
RUN pip3 install --break-system-packages --no-cache-dir \
    shodan \
    dnspython \
    requests \
    arjun

# Install Node.js tools (API testing)
RUN npm install -g newman

# Configure proxychains with Tor
COPY config/proxychains.conf /etc/proxychains4.conf

# Setup Oh-My-Zsh
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
COPY config/.zshrc /root/.zshrc

# Create entrypoint script in /usr/local/bin (avoids /root volume mount conflict)
RUN printf '#!/bin/zsh\nmkdir -p /root/.msf4\nif [ -n "$DATABASE_URL" ]; then\n  echo "production:" > /root/.msf4/database.yml\n  echo "  adapter: postgresql" >> /root/.msf4/database.yml\n  echo "  database: ${POSTGRES_DB:-kalidocker}" >> /root/.msf4/database.yml\n  echo "  username: ${POSTGRES_USER:-postgres}" >> /root/.msf4/database.yml\n  echo "  password: ${POSTGRES_PASSWORD:-postgres}" >> /root/.msf4/database.yml\n  echo "  host: postgres" >> /root/.msf4/database.yml\n  echo "  port: 5432" >> /root/.msf4/database.yml\n  echo "  pool: 5" >> /root/.msf4/database.yml\nfi\nexec /bin/zsh "$@"\n' > /usr/local/bin/entrypoint.sh && chmod +x /usr/local/bin/entrypoint.sh

# Default shell
SHELL ["/bin/zsh", "-c"]
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]